name: mcp backend deployment

on:
  workflow_dispatch:

  push:
    paths:
      - "mcp-backend/**"
    branches: ["main"]



jobs:
  deployment:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}
      url: https://github.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: SSH Setup and Cloning Repository
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ./key.pem
          chmod 600 ./key.pem
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          ssh -i ./key.pem ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} -T <<EOF
          REPO_DIR=~/mcp-backend
          echo "Removing existing repository directory if exists"
          rm -rf \$REPO_DIR
          echo "Cloning repository from the relevant branch"
          git clone --single-branch --branch ${{ github.ref_name }} https://github.com/ONDC-Official/ondc-mcp.git \$REPO_DIR
          EOF

      - name: Install Docker Compose (if not installed)
        run: |
          ssh -i ./key.pem ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} <<EOF
          # Check if Docker Compose is installed
          if ! command -v docker-compose &> /dev/null
          then
            echo "Docker Compose not found. Installing..."
            sudo curl -L "https://github.com/docker/compose/releases/download/$(curl -s https://api.github.com/repos/docker/compose/releases/latest | jq -r .tag_name)/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          else
            echo "Docker Compose is already installed."
          fi
          EOF

      - name: Write secrets to .env on EC2
        run: |
          echo "Writing secrets to .env file"
          ssh -i ./key.pem ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} <<EOF
          REPO_DIR=~/mcp-backend
          echo "Writing environment variables to .env file"
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> \$REPO_DIR/mcp-backend/.env
          echo "WIL_API_KEY=${{secrets.WIL_API_KEY }}" >> \$REPO_DIR/mcp-backend/.env

          echo "BACKEND_ENDPOINT=${{vars.BACKEND_ENDPOINT }}" >> \$REPO_DIR/mcp-backend/.env
          echo "API_URL=${{vars.API_URL }}" >> \$REPO_DIR/mcp-backend/.env


          echo "GEMINI_MODEL=gemini-2.5-pro" >> \$REPO_DIR/mcp-backend/.env
          echo "QDRANT_HOST=qdrant" >> \$REPO_DIR/mcp-backend/.env
          echo "QDRANT_PORT=6333" >> \$REPO_DIR/mcp-backend/.env
          echo "QDRANT_COLLECTION=himira_products" >> \$REPO_DIR/mcp-backend/.env
          echo "HYBRID_SEARCH_ENABLED=true" >> \$REPO_DIR/mcp-backend/.env
          echo "VECTOR_SEARCH_ENABLED=true" >> \$REPO_DIR/mcp-backend/.env
          echo "VECTOR_SIMILARITY_THRESHOLD=0.7" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_MIN_RESULTS=2" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_MAX_RESULTS=25" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_DEFAULT_LIMIT=10" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_DEFAULT_RELEVANCE=0.7" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_MIN_RELEVANCE=0.4" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_MAX_RELEVANCE=0.9" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_ADAPTIVE_SIZING=true" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_QUERY_ANALYSIS=true" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_RELEVANCE_FILTERING=true" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_CONTEXT_AWARE=true" >> \$REPO_DIR/mcp-backend/.env
          echo "SEARCH_INTENT_ANALYSIS=true" >> \$REPO_DIR/mcp-backend/.env
          echo "MOCK_AFTER_INIT=true" >> \$REPO_DIR/mcp-backend/.env
          echo "GOOGLE_CLIENT_TIMEOUT_MS=45000" >> \$REPO_DIR/mcp-backend/.env
          echo "API_PORT=8001" >> \$REPO_DIR/mcp-backend/.env
          echo "CORS_ORIGINS=*" >> \$REPO_DIR/mcp-backend/.env
          echo "RATE_LIMIT_PER_MIN=20" >> \$REPO_DIR/mcp-backend/.env
          echo "SESSION_TTL_HOURS=24" >> \$REPO_DIR/mcp-backend/.env
          echo "SESSION_STORE_PATH=/app/sessions" >> \$REPO_DIR/mcp-backend/.env
          echo "LOG_LEVEL=DEBUG" >> \$REPO_DIR/mcp-backend/.env
          echo "MCP_DEBUG_LEVEL=FULL" >> \$REPO_DIR/mcp-backend/.env
          echo "MCP_LOG_MAX_SIZE=5000" >> \$REPO_DIR/mcp-backend/.env
          echo "MCP_LOG_INCLUDE_VECTORS=false" >> \$REPO_DIR/mcp-backend/.env
          echo "DEBUG_CURL_LOGGING=true" >> \$REPO_DIR/mcp-backend/.env
          echo "ETL_MODE=init" >> \$REPO_DIR/mcp-backend/.env
          echo "MCP_TRANSPORT=stdio" >> \$REPO_DIR/mcp-backend/.env
          echo "PYTHONUNBUFFERED=1" >> \$REPO_DIR/mcp-backend/.env
          echo "SUPERVISOR_WEB_ENABLED=true" >> \$REPO_DIR/mcp-backend/.env
          echo "SUPERVISOR_WEB_PORT=9001" >> \$REPO_DIR/mcp-backend/.env
          echo "SUPERVISOR_WEB_USERNAME=admin" >> \$REPO_DIR/mcp-backend/.env
          echo "SUPERVISOR_WEB_PASSWORD=supervisor2024" >> \$REPO_DIR/mcp-backend/.env
          echo "SSE_CONNECTION_TIMEOUT=300" >> \$REPO_DIR/mcp-backend/.env
          echo "SSE_RAW_DATA_WAIT=1.0" >> \$REPO_DIR/mcp-backend/.env
          echo "SSE_QUEUE_TIMEOUT=0.5" >> \$REPO_DIR/mcp-backend/.env
          echo "API_TIMEOUT=2.0" >> \$REPO_DIR/mcp-backend/.env
          echo "API_RETRY_ATTEMPTS=2" >> \$REPO_DIR/mcp-backend/.env

          EOF

      - name: Verify .env and docker-compose.yml files
        run: |
          ssh -i ./key.pem ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} <<EOF
          REPO_DIR=~/mcp-backend/mcp-backend
          # Check if .env and docker-compose.yml files exist
          if [ ! -f \$REPO_DIR/.env ]; then
            echo ".env file not found in \$REPO_DIR!"
            exit 1
          fi
          if [ ! -f \$REPO_DIR/docker-compose.yml ]; then
            echo "docker-compose.yml file not found in \$REPO_DIR!"
            exit 1
          fi
          echo ".env and docker-compose.yml files found."
          EOF

      - name: Automation Mock Server Deployment
        run: |
          echo "Deploying with Docker Compose"
          ssh -i ./key.pem ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} <<EOF
          REPO_DIR=~/mcp-backend/mcp-backend
          cd \$REPO_DIR

          # Ensure the .env and docker-compose.yml files exist
          if [ ! -f .env ]; then
            echo ".env file not found!"
            exit 1
          fi

          if [ ! -f docker-compose.yml ]; then
            echo "docker-compose.yml file not found!"
            exit 1
          fi

          # Start the containers using Docker Compose
          echo "Running docker-compose up -d --build"
          sudo docker-compose up -d --build
          EOF
